# SPDX-License-Identifier: Apache-2.0
name: 发布构建

on:
  push:
    tags:
      - 'v*.*.*'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例如: v1.0.0)'
        required: true

jobs:
  build-release:
    name: 构建发布版本
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        board:
          - robomaster_board_c
          - robomaster_board_a
          - dm_mc02
        sample:
          - samples/motor/dji_m3508_demo
          - samples/motor/dm_demo
        exclude:
          - board: dm_mc02
            sample: samples/motor/dji_m3508_demo

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          path: motor
          fetch-depth: 0

      - name: 获取版本号
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf ccache dfu-util \
            device-tree-compiler wget python3-dev python3-pip \
            python3-setuptools python3-wheel xz-utils file make \
            gcc gcc-multilib g++-multilib libsdl2-dev libmagic1
          pip install west

      - name: 初始化 West 工作空间
        run: |
          cd motor
          west init -l .
          west update
          west zephyr-export
          pip install -r ../zephyr/scripts/requirements.txt

      - name: 下载 Zephyr SDK（缓存）
        uses: actions/cache@v4
        id: cache-sdk
        with:
          path: ~/zephyr-sdk-0.16.8
          key: zephyr-sdk-0.16.8

      - name: 安装 Zephyr SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          cd ~
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.8/zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          tar xf zephyr-sdk-0.16.8_linux-x86_64.tar.xz
          cd zephyr-sdk-0.16.8
          ./setup.sh -t arm-zephyr-eabi -h -c

      - name: 编译固件
        run: |
          cd motor
          export ZEPHYR_SDK_INSTALL_DIR=~/zephyr-sdk-0.16.8
          west build -b ${{ matrix.board }} ${{ matrix.sample }} --pristine

      - name: 生成构建信息
        run: |
          cd motor/build
          echo "Board: ${{ matrix.board }}" > build-info.txt
          echo "Sample: ${{ matrix.sample }}" >> build-info.txt
          echo "Version: ${{ steps.get_version.outputs.version }}" >> build-info.txt
          echo "Build Date: $(date -u)" >> build-info.txt
          echo "Git Commit: $(git rev-parse HEAD)" >> build-info.txt
          echo "Git Branch: $(git rev-parse --abbrev-ref HEAD)" >> build-info.txt

      - name: 打包固件
        run: |
          cd motor/build
          PACKAGE_NAME="${{ matrix.board }}-$(echo ${{ matrix.sample }} | sed 's/\//-/g')-${{ steps.get_version.outputs.version }}"
          mkdir -p release/$PACKAGE_NAME
          cp zephyr/zephyr.elf release/$PACKAGE_NAME/
          cp zephyr/zephyr.bin release/$PACKAGE_NAME/
          cp zephyr/zephyr.hex release/$PACKAGE_NAME/
          cp build-info.txt release/$PACKAGE_NAME/
          cd release
          tar -czf ${PACKAGE_NAME}.tar.gz $PACKAGE_NAME
          zip -r ${PACKAGE_NAME}.zip $PACKAGE_NAME

      - name: 上传固件（tar.gz）
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}-$(echo ${{ matrix.sample }} | sed 's/\//-/g')-tar
          path: motor/build/release/*.tar.gz
          retention-days: 90

      - name: 上传固件（zip）
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}-$(echo ${{ matrix.sample }} | sed 's/\//-/g')-zip
          path: motor/build/release/*.zip
          retention-days: 90

      - name: 发布到 Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            motor/build/release/*.tar.gz
            motor/build/release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
